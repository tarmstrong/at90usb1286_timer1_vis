<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Tangle document</title>

	<!-- Tangle -->
	<script type="text/javascript" src="Tangle.js"></script>

	<!-- TangleKit (optional) -->
	<link rel="stylesheet" href="TangleKit/TangleKit.css" type="text/css">
	<script type="text/javascript" src="TangleKit/mootools.js"></script>
	<script type="text/javascript" src="TangleKit/sprintf.js"></script>
	<script type="text/javascript" src="TangleKit/BVTouchable.js"></script>
	<script type="text/javascript" src="TangleKit/TangleKit.js"></script>

	<script type="text/javascript" src="graph.js"></script>

	<!-- example -->
	<script type="text/javascript">

    function setUpTangle () {

      var container = document.getElementById("timer-vis");
      var tangle = new Tangle(container, {
        initialize: function () {
          this.ocr1a = 0x7F;
          this.top = 0xFF;
          this.cs10 = 0;
          this.cs11 = 1;
          this.cs12 = 0;
          this.wgm13 = 0;
          this.wgm12 = 1;
          this.wgm11 = 0;
          this.wgm10 = 1;
          this.icr1 = 100;
          this.com1a1 = 1;
          this.com1a0 = 0;
        },
        update: function () {
          // Compare output mode is determined by bits COM1A[1:0]
          this.com = (this.com1a1 << 1) | (this.com1a0 << 0);

          // The clock select is determined by bits CS[2:0]
          this.csmode = (this.cs12 << 2) | (this.cs11 << 1) | (this.cs10 << 0);

          // The WGM mode is determined by bits WGM1[3:0]
          this.wgmmode = (this.wgm13 << 3) | (this.wgm12 << 2) | (this.wgm11 << 1) | (this.wgm10 << 0);

          this.not_implemented = false;
          switch (this.wgmmode) {
          case 5: this.top = 0xFF; break;
          case 6: this.top = 0x1FF; break;
          case 7: this.top = 0x3FF; break;
          case 14: this.top = this.icr1; break;
          case 15: this.top = this.ocr1a; break;
          default: this.not_implemented = true; break;
          }
          if (this.com < 2) {
            this.not_implemented = true;
          }

          var code = document.getElementById('editor').value;
          eval(code);
          timer1_graph(this.ocr1a, this.top, this.com, this.not_implemented);
        }
      });
      window.addEvent('keyup', function () {
          try {
            var code = document.getElementById('editor').value;
            eval(code);
            timer1_graph(tangle.getValue('ocr1a'), tangle.getValue('top'), tangle.getValue('com'), tangle.getValue('not_implemented'));
          }
          catch (e) {
            document.getElementById('debug').innerHTML = e;
          }
      });
    }

	</script>
  <link rel='stylesheet' href='default.css' />
  <style>
    table.reg-control td {
      font-size: 8px;
      padding: 0px 0px 0px 0px;
      margin: 0 0 0 0 ;
      text-align: center;
      max-width: 70px;
      width: 70px;
    }
    #timer-vis {
      margin: 50px 0 50px 0;
    }
    #timer-vis .controls {
      float:left;
      width: 500px;
    }
    #timer-vis-plot {
      margin-left: 40px;
    }
    #editor {
      float: left;
      width: 500px;
      height: 300px;
    }
  </style>
</head>

<body onload="setUpTangle();">

  <span data-var='asdf' class='TKToggle'></span>
  <h1>A Simple and Interactive Explanation of the Teensy's 16-bit timer (Timer1)</h1>

  <p>In the Teensy++, there are three timers. The second of these, Timer 1, is a 16-bit timer. It can be used for periodic interrupts, which lets you run a piece of code every so often. It can also be used for pulse-width modulation (PWM), which is a way to simulate analogue signals using digital signals. You can use this to dim an LED.</p>
  <p>Remember in the first lab, where you turned an LED on by setting the output of a pin to HIGH? HIGH is 5 volts. If you turn it to LOW, that's 0 volts. With digital, there's no in-between. What you can do, however, is simulate a value in between 0 and 5 by changing the value quickly enough so that it appears to be between 0 and 5. The average voltage becomes the apparent voltage.</p>
  <p>As with most things on the Teensy, you configure the behaviour of this Timer by setting various bits in various registers. It's useful to know what these registers are, and what the <code>C</code> constants for them are:
  <dl>
  <dt>TCCR1</dt><dd>The Timer Counter/Control Register has two parts: TCCR1A and TCCR1B. Depending on which bits are set on this register, Timer 1 will behave differently. You can set the compare output mode (COM), the wave generation mode (WGM), and select a clock (CS).</dd>
  </dl>

  <div id='timer-vis'>
    <div class='controls'>
    <p>
    <table class='reg-control'>
      <thead>
        <td></td>
        <td>COM1A1</td>
        <td>COM1A0</td>
        <td>COM1B1</td>
        <td>COM1B0</td>
        <td>COM1C1</td>
        <td>COM1C0</td>
        <td>WGM11</td>
        <td>WGM10</td>
      </thead>
      <tr>
        <td>TCCR1A</td>
        <td><span data-var='com1a1' class='TKToggle'></span> </td>
        <td><span data-var='com1a0' class='TKToggle'></span> </td>
        <td><input type='checkbox' name='com1b1' disabled /></td>
        <td><input type='checkbox' name='com1b0' disabled /></td>
        <td><input type='checkbox' name='com1c1' disabled /></td>
        <td><input type='checkbox' name='com1c0' disabled /></td>
        <td><span data-var='wgm11' class='TKToggle'></span> </td>
        <td><span data-var='wgm10' class='TKToggle'></span> </td>
      </tr>
    </table>
    <table class='reg-control'>
      <thead>
        <td></td>
        <td>ICNC1</td>
        <td>ICES1</td>
        <td>-</td>
        <td>WGM13</td>
        <td>WGM12</td>
        <td>CS12</td>
        <td>CS11</td>
        <td>CS10</td>
      </thead>
      <tr>
        <td>TCCR1B</td>
        <td><input type='checkbox' name='icnc1' disabled /></td>
        <td><input type='checkbox' name='ices1' disabled /></td>
        <td><input type='checkbox' name='none' disabled /></td>
        <td><span data-var='wgm13' class='TKToggle'></span> </td>
        <td><span data-var='wgm12' class='TKToggle'></span> </td>
        <td><span data-var='cs12' class='TKToggle'></span> </td>
        <td><span data-var='cs11' class='TKToggle'></span> </td>
        <td><span data-var='cs10' class='TKToggle'></span> </td>
      </tr>
    </table>
    </p>
    <p>
    The clock select is set to <span data-var='csmode'></span>.
    </p>
    <p>
    The wave generation mode is set to <span data-var='wgmmode'></span>.
    </p>
    <p>
    The ICR1 register is set to <span data-var="icr1" data-format="0x%x" class="TKNumberField"></span>
    </p>
    <p>
    The OCR1A register is set to <span data-var="ocr1a" data-format="0x%x" class="TKNumberField"></span>
    </p>
    <p>
    TOP is <span data-var="top" data-format="0x%x" class="TKAdjustableNumber"></span>.
    </p>
  </div>
    <canvas id='timer-vis-plot'>
    </canvas>
  </div>

  <div>
    <textarea id='editor'>
    </textarea>
    <pre id='debug'>
    </pre>
  </div>

</body>
</html>
